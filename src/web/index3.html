<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Belgian Trains Map</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
        #map { height: 100vh; width: 100%; }
    </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Create the map centered between Ghent and Blankenberge
    const map = L.map('map').setView([51.15, 3.42], 10);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
    }).addTo(map);

    const trainMarkers = {};  // store Leaflet markers by train_id

    // Color code by delay
    function getColor(delay) {
        if (!delay || delay === 0) return 'green';
        if (delay <= 300) return 'orange';
        return 'red';
    }

    async function updateTrains() {
        try {
            const response = await fetch('http://127.0.0.1:8000/active_trains');
            const trains = await response.json();

            trains.forEach(train => {
                const {train_id, lat, lon, delay, eta} = train;

                const popupText = `Train: ${train_id}<br>Delay: ${delay || 0}s<br>ETA: ${eta || 'N/A'}`;

                if (trainMarkers[train_id]) {
                    // Move existing marker
                    trainMarkers[train_id].setLatLng([lat, lon]);

                    // Update color
                    trainMarkers[train_id].setStyle({
                        color: getColor(delay),
                        fillColor: getColor(delay)
                    });

                    // Update tooltip content
                    trainMarkers[train_id].setTooltipContent(popupText);

                } else {
                    // Create new marker
                    const marker = L.circleMarker([lat, lon], {
                        radius: 8,
                        color: getColor(delay),
                        fillColor: getColor(delay),
                        fillOpacity: 0.8
                    }).addTo(map);

                    // Bind tooltip for hover
                    marker.bindTooltip(popupText, {
                        permanent: false,   // only shows on hover
                        direction: 'top',
                        sticky: true        // follows cursor
                    });

                    trainMarkers[train_id] = marker;
                }
            });

        } catch (err) {
            console.error("Failed to fetch train positions", err);
        }
    }

    // Update every 5 seconds
    updateTrains();
    setInterval(updateTrains, 5000);

</script>
</body>
</html>